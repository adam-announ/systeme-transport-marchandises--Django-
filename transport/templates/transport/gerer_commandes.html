{% extends 'transport/base.html' %}

{% block title %}Gestion des commandes{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-list"></i> Gestion des commandes</h2>
        <p class="text-muted">Administration et assignation des commandes</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-primary" onclick="assignAllAvailable()">
                <i class="fas fa-magic"></i> Assignation automatique
            </button>
            <button class="btn btn-outline-success" onclick="exportCommands()">
                <i class="fas fa-download"></i> Exporter
            </button>
        </div>
    </div>
</div>

<!-- Filtres et recherche -->
<div class="card mb-4">
    <div class="card-body">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Statut</label>
                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                    <option value="">Tous les statuts</option>
                    <option value="en_attente">En attente</option>
                    <option value="assignee">Assignée</option>
                    <option value="en_cours">En cours</option>
                    <option value="livree">Livrée</option>
                    <option value="annulee">Annulée</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="dateFilter" class="form-label">Date</label>
                <input type="date" class="form-control" id="dateFilter" onchange="applyFilters()">
            </div>
            
            <div class="col-md-3">
                <label for="transporterFilter" class="form-label">Transporteur</label>
                <select class="form-select" id="transporterFilter" onchange="applyFilters()">
                    <option value="">Tous les transporteurs</option>
                    {% for transporteur in transporteurs %}
                    <option value="{{ transporteur.id }}">{{ transporteur.utilisateur.prenom }} {{ transporteur.utilisateur.nom }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="searchInput" class="form-label">Recherche</label>
                <input type="text" class="form-control" id="searchInput" placeholder="N° commande, client..." onkeyup="applyFilters()">
            </div>
        </form>
    </div>
</div>

<!-- Statistiques rapides -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number" id="totalCommandes">{{ commandes.paginator.count }}</div>
            <div>Total commandes</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #ffeaa7, #fdcb6e);">
            <div class="stat-number" id="commandesEnAttente">--</div>
            <div>En attente</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #74b9ff, #0984e3);">
            <div class="stat-number" id="commandesAssignees">--</div>
            <div>Assignées</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #00b894, #00cec9);">
            <div class="stat-number" id="commandesLivrees">--</div>
            <div>Livrées</div>
        </div>
    </div>
</div>

<!-- Actions en lot -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="fas fa-tasks"></i> Actions en lot</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAll">
                        Sélectionner tout
                    </label>
                </div>
                <div class="mt-2">
                    <span id="selectedCount">0</span> commande(s) sélectionnée(s)
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="bulkAssign()" disabled id="bulkAssignBtn">
                        <i class="fas fa-user-plus"></i> Assigner transporteur
                    </button>
                    <button class="btn btn-outline-warning" onclick="bulkUpdateStatus()" disabled id="bulkStatusBtn">
                        <i class="fas fa-edit"></i> Changer statut
                    </button>
                    <button class="btn btn-outline-danger" onclick="bulkCancel()" disabled id="bulkCancelBtn">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des commandes -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Liste des commandes</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="commandesTable">
                <thead>
                    <tr>
                        <th width="30">
                            <input type="checkbox" id="masterCheckbox" onchange="toggleSelectAll()">
                        </th>
                        <th>N° Commande</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Marchandise</th>
                        <th>Itinéraire</th>
                        <th>Transporteur</th>
                        <th>Statut</th>
                        <th>Priorité</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for commande in commandes %}
                    <tr data-status="{{ commande.statut }}" data-date="{{ commande.date_creation|date:'Y-m-d' }}">
                        <td>
                            <input type="checkbox" class="command-checkbox" value="{{ commande.id }}" onchange="updateSelectedCount()">
                        </td>
                        <td>
                            <strong>#{{ commande.id }}</strong>
                            <br><small class="text-muted">{{ commande.date_creation|date:"d/m/Y H:i" }}</small>
                        </td>
                        <td>
                            {{ commande.client.prenom }} {{ commande.client.nom }}
                            <br><small class="text-muted">{{ commande.client.telephone }}</small>
                        </td>
                        <td>{{ commande.date_creation|date:"d/m/Y" }}</td>
                        <td>
                            <strong>{{ commande.type_marchandise }}</strong>
                            <br><small class="text-muted">{{ commande.poids }} kg</small>
                        </td>
                        <td>
                            <small>
                                <strong>De:</strong> {{ commande.adresse_enlevement.ville }}<br>
                                <strong>Vers:</strong> {{ commande.adresse_livraison.ville }}
                            </small>
                            <br>
                            {% if commande.itineraire %}
                            <small class="text-info">{{ commande.itineraire.distance|floatformat:1 }} km</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if commande.transporteur %}
                                <div class="d-flex align-items-center">
                                    <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                                    <div>
                                        <strong>{{ commande.transporteur.utilisateur.prenom }} {{ commande.transporteur.utilisateur.nom }}</strong>
                                        <br><small class="text-muted">{{ commande.transporteur.matricule }}</small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-center">
                                    <span class="text-muted">Non assigné</span>
                                    <br>
                                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="quickAssign({{ commande.id }})">
                                        <i class="fas fa-plus"></i> Assigner
                                    </button>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ commande.statut }}">
                                {% if commande.statut == 'en_attente' %}
                                    <i class="fas fa-clock"></i> En attente
                                {% elif commande.statut == 'assignee' %}
                                    <i class="fas fa-user-check"></i> Assignée
                                {% elif commande.statut == 'en_cours' %}
                                    <i class="fas fa-truck"></i> En cours
                                {% elif commande.statut == 'livree' %}
                                    <i class="fas fa-check"></i> Livrée
                                {% elif commande.statut == 'annulee' %}
                                    <i class="fas fa-times"></i> Annulée
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <select class="form-select form-select-sm priority-select" data-commande-id="{{ commande.id }}" onchange="updatePriority(this)">
                                <option value="low">Faible</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">Élevée</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewCommand({{ commande.id }})" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="showRouteModal({{ commande.id }})" title="Itinéraire">
                                    <i class="fas fa-route"></i>
                                </button>
                                {% if commande.statut == 'en_attente' %}
                                <button class="btn btn-outline-warning" onclick="quickAssign({{ commande.id }})" title="Assigner rapidement">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                {% endif %}
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Plus d'actions">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editCommand({{ commande.id }})">
                                            <i class="fas fa-edit"></i> Modifier
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="duplicateCommand({{ commande.id }})">
                                            <i class="fas fa-copy"></i> Dupliquer
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="cancelCommand({{ commande.id }})">
                                            <i class="fas fa-times"></i> Annuler
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if commandes.has_other_pages %}
        <nav aria-label="Pagination des commandes">
            <ul class="pagination justify-content-center">
                {% if commandes.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ commandes.previous_page_number }}">Précédent</a>
                    </li>
                {% endif %}
                
                {% for page_num in commandes.paginator.page_range %}
                    {% if page_num == commandes.number %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if commandes.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ commandes.next_page_number }}">Suivant</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Modal assignation rapide -->
<div class="modal fade" id="quickAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Assignation rapide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="quickTransporter" class="form-label">Sélectionner un transporteur</label>
                    <select class="form-select" id="quickTransporter">
                        <option value="">Choisir un transporteur...</option>
                        {% for transporteur in transporteurs %}
                        {% if transporteur.disponibilite %}
                        <option value="{{ transporteur.id }}" data-capacity="{{ transporteur.capacite_charge }}" data-vehicle="{{ transporteur.type_vehicule }}">
                            {{ transporteur.utilisateur.prenom }} {{ transporteur.utilisateur.nom }} 
                            ({{ transporteur.matricule }} - {{ transporteur.type_vehicule }})
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div id="transporterInfo" class="alert alert-info" style="display: none;">
                    <h6>Informations du transporteur</h6>
                    <p id="transporterDetails"></p>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoOptimize" checked>
                    <label class="form-check-label" for="autoOptimize">
                        Optimiser automatiquement l'itinéraire
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="executeQuickAssign()">Assigner</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal actions en lot -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkActionTitle"><i class="fas fa-tasks"></i> Action en lot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bulkActionContent">
                <!-- Contenu dynamique selon l'action -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="bulkActionExecute">Exécuter</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedCommands = [];
let currentCommandId = null;

// Mettre à jour les statistiques
function updateStats() {
    const rows = document.querySelectorAll('#commandesTable tbody tr');
    let stats = {
        'en_attente': 0,
        'assignee': 0,
        'en_cours': 0,
        'livree': 0,
        'annulee': 0
    };
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const status = row.dataset.status;
            if (stats.hasOwnProperty(status)) {
                stats[status]++;
            }
        }
    });
    
    document.getElementById('commandesEnAttente').textContent = stats['en_attente'];
    document.getElementById('commandesAssignees').textContent = stats['assignee'];
    document.getElementById('commandesLivrees').textContent = stats['livree'];
}

// Appliquer les filtres
function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const transporterFilter = document.getElementById('transporterFilter').value;
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('#commandesTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let show = true;
        
        // Filtre par statut
        if (statusFilter && row.dataset.status !== statusFilter) {
            show = false;
        }
        
        // Filtre par date
        if (dateFilter && row.dataset.date !== dateFilter) {
            show = false;
        }
        
        // Filtre par recherche
        if (searchInput && !row.textContent.toLowerCase().includes(searchInput)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    document.getElementById('totalCommandes').textContent = visibleCount;
    updateStats();
}

// Gestion de la sélection
function toggleSelectAll() {
    const masterCheckbox = document.getElementById('masterCheckbox');
    const checkboxes = document.querySelectorAll('.command-checkbox');
    
    checkboxes.forEach(checkbox => {
        if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = masterCheckbox.checked;
        }
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.command-checkbox:checked');
    selectedCommands = Array.from(checkboxes).map(cb => cb.value);
    
    document.getElementById('selectedCount').textContent = selectedCommands.length;
    
    // Activer/désactiver les boutons d'action en lot
    const bulkButtons = ['bulkAssignBtn', 'bulkStatusBtn', 'bulkCancelBtn'];
    bulkButtons.forEach(btnId => {
        document.getElementById(btnId).disabled = selectedCommands.length === 0;
    });
}

// Assignation rapide
function quickAssign(commandId) {
    currentCommandId = commandId;
    const modal = new bootstrap.Modal(document.getElementById('quickAssignModal'));
    modal.show();
}

function executeQuickAssign() {
    const transporterId = document.getElementById('quickTransporter').value;
    const autoOptimize = document.getElementById('autoOptimize').checked;
    
    if (!transporterId) {
        showToast('Veuillez sélectionner un transporteur', 'warning');
        return;
    }
    
    makeAjaxRequest('/api/assigner-transporteur/', {
        commande_id: currentCommandId,
        transporteur_id: transporterId,
        auto_optimize: autoOptimize
    }, function(response) {
        showToast('Transporteur assigné avec succès', 'success');
        bootstrap.Modal.getInstance(document.getElementById('quickAssignModal')).hide();
        location.reload();
    }, function(error) {
        showToast('Erreur lors de l\'assignation: ' + error, 'danger');
    });
}

// Afficher les informations du transporteur
document.getElementById('quickTransporter').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const info = document.getElementById('transporterInfo');
    
    if (this.value) {
        const capacity = selectedOption.dataset.capacity;
        const vehicle = selectedOption.dataset.vehicle;
        
        document.getElementById('transporterDetails').innerHTML = `
            <strong>Véhicule:</strong> ${vehicle}<br>
            <strong>Capacité:</strong> ${capacity} kg<br>
            <strong>Statut:</strong> <span class="badge bg-success">Disponible</span>
        `;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
});

// Actions en lot
function bulkAssign() {
    if (selectedCommands.length === 0) return;
    
    const content = `
        <p>Assigner un transporteur à <strong>${selectedCommands.length}</strong> commande(s) sélectionnée(s).</p>
        <div class="mb-3">
            <label for="bulkTransporter" class="form-label">Transporteur</label>
            <select class="form-select" id="bulkTransporter">
                <option value="">Assignation automatique</option>
                {% for transporteur in transporteurs %}
                {% if transporteur.disponibilite %}
                <option value="{{ transporteur.id }}">
                    {{ transporteur.utilisateur.prenom }} {{ transporteur.utilisateur.nom }}
                </option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="bulkOptimize" checked>
            <label class="form-check-label" for="bulkOptimize">
                Optimiser les itinéraires
            </label>
        </div>
    `;
    
    showBulkActionModal('Assignation en lot', content, executeBulkAssign);
}

function bulkUpdateStatus() {
    if (selectedCommands.length === 0) return;
    
    const content = `
        <p>Changer le statut de <strong>${selectedCommands.length}</strong> commande(s) sélectionnée(s).</p>
        <div class="mb-3">
            <label for="bulkStatus" class="form-label">Nouveau statut</label>
            <select class="form-select" id="bulkStatus">
                <option value="en_attente">En attente</option>
                <option value="assignee">Assignée</option>
                <option value="en_cours">En cours</option>
                <option value="livree">Livrée</option>
                <option value="annulee">Annulée</option>
            </select>
        </div>
    `;
    
    showBulkActionModal('Changement de statut en lot', content, executeBulkStatusUpdate);
}

function bulkCancel() {
    if (selectedCommands.length === 0) return;
    
    const content = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            Êtes-vous sûr de vouloir annuler <strong>${selectedCommands.length}</strong> commande(s) ?
            Cette action est irréversible.
        </div>
    `;
    
    showBulkActionModal('Annulation en lot', content, executeBulkCancel);
}

function showBulkActionModal(title, content, executeFunction) {
    document.getElementById('bulkActionTitle').innerHTML = '<i class="fas fa-tasks"></i> ' + title;
    document.getElementById('bulkActionContent').innerHTML = content;
    document.getElementById('bulkActionExecute').onclick = executeFunction;
    
    const modal = new bootstrap.Modal(document.getElementById('bulkActionModal'));
    modal.show();
}

function executeBulkAssign() {
    const transporterId = document.getElementById('bulkTransporter').value;
    const optimize = document.getElementById('bulkOptimize').checked;
    
    makeAjaxRequest('/api/assignation-automatique/', {
        commandes: selectedCommands,
        transporteur_id: transporterId || null,
        optimiser: optimize
    }, function(response) {
        showToast(`${response.assignations.length} commandes assignées`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('bulkActionModal')).hide();
        location.reload();
    }, function(error) {
        showToast('Erreur lors de l\'assignation: ' + error, 'danger');
    });
}

function executeBulkStatusUpdate() {
    const newStatus = document.getElementById('bulkStatus').value;
    
    const promises = selectedCommands.map(commandId => {
        return fetch('/api/mettre-a-jour-statut/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                commande_id: commandId,
                statut: newStatus
            })
        });
    });
    
    Promise.all(promises).then(() => {
        showToast(`${selectedCommands.length} commandes mises à jour`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('bulkActionModal')).hide();
        location.reload();
    }).catch(error => {
        showToast('Erreur lors de la mise à jour', 'danger');
    });
}

function executeBulkCancel() {
    executeBulkStatusUpdate = function() {
        document.getElementById('bulkStatus').value = 'annulee';
        executeBulkStatusUpdate();
    };
    executeBulkStatusUpdate();
}

// Assignation automatique pour toutes les commandes disponibles
function assignAllAvailable() {
    showLoading();
    
    makeAjaxRequest('/api/assignation-automatique/', {
        strategie: 'balanced',
        distance_max: 50,
        seulement_disponibles: true
    }, function(response) {
        hideLoading();
        showToast(`${response.assignations.length} commandes assignées automatiquement`, 'success');
        location.reload();
    }, function(error) {
        hideLoading();
        showToast('Erreur lors de l\'assignation automatique: ' + error, 'danger');
    });
}

// Export des commandes
function exportCommands() {
    showLoading();
    
    setTimeout(() => {
        hideLoading();
        
        const csvContent = 'N° Commande,Client,Date,Marchandise,Statut,Transporteur\n' +
            Array.from(document.querySelectorAll('#commandesTable tbody tr')).map(row => {
                if (row.style.display === 'none') return '';
                const cells = row.querySelectorAll('td');
                return [
                    cells[1].textContent.replace(/\s+/g, ' ').trim(),
                    cells[2].textContent.replace(/\s+/g, ' ').trim(),
                    cells[3].textContent.trim(),
                    cells[4].textContent.replace(/\s+/g, ' ').trim(),
                    cells[7].textContent.replace(/\s+/g, ' ').trim(),
                    cells[6].textContent.replace(/\s+/g, ' ').trim()
                ].join(',');
            }).filter(row => row).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'commandes_export.csv';
        link.click();
        
        showToast('Export terminé', 'success');
    }, 1000);
}

// Autres fonctions
function viewCommand(commandId) {
    window.location.href = `/commande/suivre/${commandId}/`;
}

function showRouteModal(commandId) {
    showToast(`Affichage de l'itinéraire pour la commande #${commandId}`, 'info');
}

function editCommand(commandId) {
    showToast(`Édition de la commande #${commandId}`, 'info');
}

function duplicateCommand(commandId) {
    showToast(`Duplication de la commande #${commandId}`, 'info');
}

function cancelCommand(commandId) {
    if (confirm('Êtes-vous sûr de vouloir annuler cette commande ?')) {
        makeAjaxRequest('/api/mettre-a-jour-statut/', {
            commande_id: commandId,
            statut: 'annulee'
        }, function(response) {
            showToast('Commande annulée', 'success');
            location.reload();
        }, function(error) {
            showToast('Erreur lors de l\'annulation: ' + error, 'danger');
        });
    }
}

function updatePriority(selectElement) {
    const commandId = selectElement.dataset.commandeId;
    const priority = selectElement.value;
    
    // Ici vous pourriez ajouter un appel API pour sauvegarder la priorité
    showToast(`Priorité mise à jour pour la commande #${commandId}`, 'success');
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    updateSelectedCount();
});
</script>
{% endblock %}