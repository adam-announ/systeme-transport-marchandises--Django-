{% extends 'transport/base.html' %}

{% block title %}Administration - TransportPro{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-cog"></i> Panneau d'administration</h2>
        <p class="text-muted">Vue d'ensemble du système</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="exportData()">
                <i class="fas fa-download"></i> Exporter données
            </button>
            <button class="btn btn-outline-success" onclick="generateReport()">
                <i class="fas fa-chart-line"></i> Rapport complet
            </button>
        </div>
    </div>
</div>

<!-- Statistiques principales -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number">{{ stats.total_commandes }}</div>
            <div>Commandes totales</div>
            <small class="text-muted">+12% ce mois</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #fd79a8, #fdcb6e);">
            <div class="stat-number">{{ stats.commandes_en_cours }}</div>
            <div>En cours</div>
            <small class="text-white">{{ stats.commandes_en_cours }} actives</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #00b894, #00cec9);">
            <div class="stat-number">{{ stats.total_transporteurs }}</div>
            <div>Transporteurs</div>
            <small class="text-white">{{ stats.transporteurs_disponibles }} disponibles</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">
            <div class="stat-number">{{ stats.total_clients }}</div>
            <div>Clients</div>
            <small class="text-white">Actifs ce mois</small>
        </div>
    </div>
</div>

<!-- Actions d'administration -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-3x text-primary mb-3"></i>
                <h5>Gérer utilisateurs</h5>
                <p class="text-muted">Ajouter, modifier, supprimer des utilisateurs</p>
                <button class="btn btn-primary" onclick="manageUsers()">Gérer</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-truck fa-3x text-success mb-3"></i>
                <h5>Gérer transporteurs</h5>
                <p class="text-muted">Configuration des véhicules et capacités</p>
                <button class="btn btn-success" onclick="manageTransporters()">Gérer</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-cogs fa-3x text-warning mb-3"></i>
                <h5>Paramètres système</h5>
                <p class="text-muted">Configuration générale du système</p>
                <button class="btn btn-warning" onclick="systemSettings()">Configurer</button>
            </div>
        </div>
    </div>
</div>

<!-- Graphiques et analytics -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Évolution des commandes</h5>
            </div>
            <div class="card-body">
                <canvas id="ordersChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Répartition par statut</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Commandes récentes et alertes -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Commandes récentes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Client</th>
                                <th>Marchandise</th>
                                <th>Statut</th>
                                <th>Transporteur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commande in commandes_recentes %}
                            <tr>
                                <td><strong>#{{ commande.id }}</strong></td>
                                <td>{{ commande.client.prenom }} {{ commande.client.nom }}</td>
                                <td>
                                    {{ commande.type_marchandise }}<br>
                                    <small class="text-muted">{{ commande.poids }} kg</small>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ commande.statut }}">
                                        {% if commande.statut == 'en_attente' %}En attente
                                        {% elif commande.statut == 'assignee' %}Assignée
                                        {% elif commande.statut == 'en_cours' %}En cours
                                        {% elif commande.statut == 'livree' %}Livrée
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if commande.transporteur %}
                                        {{ commande.transporteur.utilisateur.prenom }} {{ commande.transporteur.utilisateur.nom }}
                                    {% else %}
                                        <span class="text-muted">Non assigné</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewOrder({{ commande.id }})" title="Voir">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if commande.statut == 'en_attente' %}
                                        <button class="btn btn-outline-success" onclick="assignTransporter({{ commande.id }})" title="Assigner">
                                            <i class="fas fa-user-plus"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'transport:gerer_commandes' %}" class="btn btn-outline-primary">
                        Voir toutes les commandes
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Alertes système</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-clock"></i> 3 commandes en retard
                </div>
                <div class="alert alert-info alert-sm">
                    <i class="fas fa-truck"></i> 2 transporteurs indisponibles
                </div>
                <div class="alert alert-success alert-sm">
                    <i class="fas fa-check"></i> Système opérationnel
                </div>
                
                <h6 class="mt-4">Performance aujourd'hui</h6>
                <div class="progress mb-2">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 85%">
                        Livraisons: 85%
                    </div>
                </div>
                <div class="progress mb-2">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 70%">
                        Satisfaction: 70%
                    </div>
                </div>
                <div class="progress">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 90%">
                        Utilisation flotte: 90%
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Activité récente</h5>
            </div>
            <div class="card-body">
                <div class="activity-feed">
                    <div class="activity-item">
                        <i class="fas fa-plus text-success"></i>
                        <div>
                            <strong>Nouvelle commande</strong><br>
                            <small class="text-muted">Il y a 5 minutes</small>
                        </div>
                    </div>
                    <div class="activity-item">
                        <i class="fas fa-truck text-primary"></i>
                        <div>
                            <strong>Transporteur assigné</strong><br>
                            <small class="text-muted">Il y a 15 minutes</small>
                        </div>
                    </div>
                    <div class="activity-item">
                        <i class="fas fa-check text-success"></i>
                        <div>
                            <strong>Livraison confirmée</strong><br>
                            <small class="text-muted">Il y a 1 heure</small>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'transport:journal_activite' %}" class="btn btn-outline-secondary btn-sm">
                        Voir journal complet
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal gestion utilisateurs -->
<div class="modal fade" id="usersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users"></i> Gestion des utilisateurs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col">
                        <button class="btn btn-primary" onclick="createUser()">
                            <i class="fas fa-plus"></i> Nouvel utilisateur
                        </button>
                    </div>
                    <div class="col-auto">
                        <input type="search" class="form-control" placeholder="Rechercher..." id="userSearch">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Rôle</th>
                                <th>Statut</th>
                                <th>Dernière connexion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Données chargées dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal paramètres système -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cogs"></i> Paramètres système</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Tarification</h6>
                            <div class="mb-3">
                                <label for="baseFare" class="form-label">Tarif de base (€)</label>
                                <input type="number" class="form-control" id="baseFare" value="50" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="pricePerKg" class="form-label">Prix par kg (€)</label>
                                <input type="number" class="form-control" id="pricePerKg" value="2.00" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="pricePerKm" class="form-label">Prix par km (€)</label>
                                <input type="number" class="form-control" id="pricePerKm" value="1.50" step="0.01">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Notifications</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                <label class="form-check-label" for="emailNotifications">
                                    Notifications par email
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="smsNotifications">
                                <label class="form-check-label" for="smsNotifications">
                                    Notifications par SMS
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="notificationFreq" class="form-label">Fréquence de mise à jour</label>
                                <select class="form-select" id="notificationFreq">
                                    <option value="realtime">Temps réel</option>
                                    <option value="5min">Toutes les 5 minutes</option>
                                    <option value="15min">Toutes les 15 minutes</option>
                                    <option value="1hour">Toutes les heures</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Sécurité</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                                <label class="form-check-label" for="twoFactorAuth">
                                    Authentification à deux facteurs
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="sessionTimeout" class="form-label">Timeout session (minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" value="60">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Maintenance</h6>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                <label class="form-check-label" for="maintenanceMode">
                                    Mode maintenance
                                </label>
                            </div>
                            <div class="mb-3">
                                <label for="backupFreq" class="form-label">Fréquence de sauvegarde</label>
                                <select class="form-select" id="backupFreq">
                                    <option value="daily">Quotidienne</option>
                                    <option value="weekly">Hebdomadaire</option>
                                    <option value="monthly">Mensuelle</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.activity-feed {
    max-height: 200px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

.alert-sm {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.progress {
    height: 20px;
}

.progress-bar {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Graphique d'évolution des commandes
const ordersCtx = document.getElementById('ordersChart').getContext('2d');
const ordersChart = new Chart(ordersCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun'],
        datasets: [{
            label: 'Commandes',
            data: [65, 78, 90, 81, 95, 108],
            borderColor: 'rgb(52, 152, 219)',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4
        }, {
            label: 'Livraisons',
            data: [60, 75, 88, 79, 92, 105],
            borderColor: 'rgb(39, 174, 96)',
            backgroundColor: 'rgba(39, 174, 96, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Graphique de répartition des statuts
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['En attente', 'Assignée', 'En cours', 'Livrée'],
        datasets: [{
            data: [12, 8, 15, 65],
            backgroundColor: [
                '#ffeaa7',
                '#74b9ff',
                '#fd79a8',
                '#00b894'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function manageUsers() {
    loadUsersData();
    const modal = new bootstrap.Modal(document.getElementById('usersModal'));
    modal.show();
}

function loadUsersData() {
    // Simuler le chargement des données utilisateurs
    const usersData = [
        { id: 1, name: 'Jean Dupont', email: 'jean@test.com', role: 'Client', status: 'Actif', lastLogin: '2025-01-15 10:30' },
        { id: 2, name: 'Pierre Martin', email: 'pierre@test.com', role: 'Transporteur', status: 'Actif', lastLogin: '2025-01-15 09:15' },
        { id: 3, name: 'Marie Durand', email: 'marie@test.com', role: 'Planificateur', status: 'Inactif', lastLogin: '2025-01-14 16:45' }
    ];
    
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';
    
    usersData.forEach(user => {
        const row = `
            <tr>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td><span class="badge bg-primary">${user.role}</span></td>
                <td>
                    <span class="badge ${user.status === 'Actif' ? 'bg-success' : 'bg-secondary'}">
                        ${user.status}
                    </span>
                </td>
                <td>${user.lastLogin}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function createUser() {
    showToast('Fonctionnalité de création d\'utilisateur à implémenter', 'info');
}

function editUser(userId) {
    showToast(`Modification de l'utilisateur ${userId}`, 'info');
}

function deleteUser(userId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
        showToast(`Utilisateur ${userId} supprimé`, 'success');
        loadUsersData(); // Recharger les données
    }
}

function manageTransporters() {
    showToast('Redirection vers la gestion des transporteurs', 'info');
    // window.location.href = '/admin/transport/transporteur/';
}

function systemSettings() {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
}

function saveSettings() {
    const settings = {
        baseFare: document.getElementById('baseFare').value,
        pricePerKg: document.getElementById('pricePerKg').value,
        pricePerKm: document.getElementById('pricePerKm').value,
        emailNotifications: document.getElementById('emailNotifications').checked,
        smsNotifications: document.getElementById('smsNotifications').checked,
        notificationFreq: document.getElementById('notificationFreq').value,
        twoFactorAuth: document.getElementById('twoFactorAuth').checked,
        sessionTimeout: document.getElementById('sessionTimeout').value,
        maintenanceMode: document.getElementById('maintenanceMode').checked,
        backupFreq: document.getElementById('backupFreq').value
    };
    
    makeAjaxRequest('/api/save-settings/', settings, function(response) {
        showToast('Paramètres sauvegardés avec succès', 'success');
        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    }, function(error) {
        showToast('Erreur lors de la sauvegarde: ' + error, 'danger');
    });
}

function viewOrder(orderId) {
    window.location.href = `/commande/suivre/${orderId}/`;
}

function assignTransporter(orderId) {
    showToast('Redirection vers l\'assignation de transporteur', 'info');
    window.location.href = `/commandes/gerer/#commande-${orderId}`;
}

function exportData() {
    showLoading();
    
    // Simuler l'export de données
    setTimeout(() => {
        hideLoading();
        
        const csvContent = `N° Commande,Client,Marchandise,Statut,Date\n` +
            `001,Jean Dupont,Électronique,Livrée,2025-01-15\n` +
            `002,Marie Martin,Textile,En cours,2025-01-15\n` +
            `003,Pierre Durand,Alimentaire,En attente,2025-01-15`;
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'commandes_export.csv';
        link.click();
        
        showToast('Données exportées avec succès', 'success');
    }, 2000);
}

function generateReport() {
    showLoading();
    
    // Simuler la génération d'un rapport
    setTimeout(() => {
        hideLoading();
        
        const reportContent = `RAPPORT MENSUEL - TransportPro\n` +
            `Période: Janvier 2025\n\n` +
            `STATISTIQUES GÉNÉRALES:\n` +
            `- Commandes totales: {{ stats.total_commandes }}\n` +
            `- Commandes livrées: ${Math.round({{ stats.total_commandes }} * 0.85)}\n` +
            `- Taux de réussite: 85%\n` +
            `- Transporteurs actifs: {{ stats.total_transporteurs }}\n` +
            `- Clients actifs: {{ stats.total_clients }}\n\n` +
            `PERFORMANCE:\n` +
            `- Délai moyen de livraison: 2.3 jours\n` +
            `- Satisfaction client: 4.2/5\n` +
            `- Incidents signalés: 3\n\n` +
            `Généré le: ${new Date().toLocaleDateString('fr-FR')}`;
        
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'rapport_mensuel.txt';
        link.click();
        
        showToast('Rapport généré avec succès', 'success');
    }, 3000);
}

// Recherche d'utilisateurs
document.getElementById('userSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Actualisation automatique des statistiques
setInterval(() => {
    // Simuler la mise à jour des statistiques
    const stats = document.querySelectorAll('.stat-number');
    stats.forEach(stat => {
        const currentValue = parseInt(stat.textContent);
        const variation = Math.floor(Math.random() * 3) - 1; // -1, 0, ou 1
        if (variation !== 0 && currentValue > 0) {
            stat.textContent = currentValue + variation;
        }
    });
}, 30000); // Toutes les 30 secondes
</script>
{% endblock %}