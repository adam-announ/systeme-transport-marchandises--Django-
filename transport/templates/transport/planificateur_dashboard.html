{% extends 'transport/base.html' %}

{% block title %}Planificateur - TransportPro{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-route"></i> Planification et optimisation</h2>
        <p class="text-muted">Optimisation des itinéraires et gestion des livraisons</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-primary" onclick="optimizeAllRoutes()">
                <i class="fas fa-magic"></i> Optimiser tout
            </button>
            <button class="btn btn-outline-success" onclick="generateOptimizationReport()">
                <i class="fas fa-chart-line"></i> Rapport
            </button>
        </div>
    </div>
</div>

<!-- Statistiques de planification -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number">{{ commandes_en_attente }}</div>
            <div>Commandes en attente</div>
            <small class="text-muted">À planifier</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #fd79a8, #fdcb6e);">
            <div class="stat-number">{{ transporteurs_disponibles }}</div>
            <div>Transporteurs disponibles</div>
            <small class="text-white">Prêts pour missions</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #00b894, #00cec9);">
            <div class="stat-number">85%</div>
            <div>Taux d'optimisation</div>
            <small class="text-white">Gain de temps</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stat-card text-center" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">
            <div class="stat-number">127 km</div>
            <div>Distance économisée</div>
            <small class="text-white">Cette semaine</small>
        </div>
    </div>
</div>

<!-- Actions de planification -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-route fa-3x text-primary mb-3"></i>
                <h5>Optimiser itinéraires</h5>
                <p class="text-muted">Calculer les meilleurs itinéraires pour toutes les commandes</p>
                <button class="btn btn-primary" onclick="optimizeRoutes()">Optimiser</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-3x text-success mb-3"></i>
                <h5>Assigner transporteurs</h5>
                <p class="text-muted">Attribution automatique ou manuelle des missions</p>
                <button class="btn btn-success" onclick="assignTransporters()">Assigner</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                <h5>Planifier livraisons</h5>
                <p class="text-muted">Organiser les créneaux de livraison optimaux</p>
                <button class="btn btn-warning" onclick="scheduleDeliveries()">Planifier</button>
            </div>
        </div>
    </div>
</div>

<!-- Vue d'ensemble des opérations -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map"></i> Carte des opérations en cours</h5>
            </div>
            <div class="card-body">
                <form id="optimizationForm">
                    <div class="mb-3">
                        <label for="algorithmType" class="form-label">Type d'algorithme</label>
                        <select class="form-select" id="algorithmType">
                            <option value="tsp">Problème du voyageur de commerce (TSP)</option>
                            <option value="vrp">Problème de routage de véhicules (VRP)</option>
                            <option value="cvrp">VRP avec contraintes de capacité</option>
                            <option value="vrptw">VRP avec fenêtres temporelles</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="optimizationCriteria" class="form-label">Critère d'optimisation</label>
                        <select class="form-select" id="optimizationCriteria">
                            <option value="distance">Distance minimale</option>
                            <option value="time">Temps minimal</option>
                            <option value="cost">Coût minimal</option>
                            <option value="fuel">Consommation carburant</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="considerTraffic" checked>
                            <label class="form-check-label" for="considerTraffic">
                                Prendre en compte le trafic
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="considerWeather">
                            <label class="form-check-label" for="considerWeather">
                                Prendre en compte la météo
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="allowMultipleStops" checked>
                            <label class="form-check-label" for="allowMultipleStops">
                                Permettre plusieurs arrêts
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="runOptimization()">
                        <i class="fas fa-play"></i> Lancer l'optimisation
                    </button>
                </form>
                
                <div id="optimizationResults" class="mt-3" style="display: none;">
                    <h6>Résultats de l'optimisation</h6>
                    <div class="alert alert-success">
                        <i class="fas fa-check"></i> Optimisation terminée avec succès!
                        <ul class="mb-0 mt-2">
                            <li>Distance économisée: <strong id="savedDistance">--</strong></li>
                            <li>Temps économisé: <strong id="savedTime">--</strong></li>
                            <li>Coût réduit: <strong id="savedCost">--</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Analyse de performance</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="250"></canvas>
                
                <div class="mt-3">
                    <h6>Métriques clés</h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-value">92%</div>
                                <div class="metric-label">Efficacité des routes</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-value">2.3h</div>
                                <div class="metric-label">Temps moyen de livraison</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-value">15%</div>
                                <div class="metric-label">Réduction des coûts</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-value">98%</div>
                                <div class="metric-label">Taux de livraison</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de planification détaillée -->
<div class="modal fade" id="planningModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> Planification détaillée</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="planningMap" style="height: 500px;"></div>
                    </div>
                    <div class="col-md-4">
                        <h6>Détails de la planification</h6>
                        <div id="planningDetails">
                            <!-- Chargé dynamiquement -->
                        </div>
                        
                        <h6 class="mt-4">Actions</h6>
                        <button class="btn btn-success btn-sm mb-2 w-100" onclick="validatePlanning()">
                            <i class="fas fa-check"></i> Valider la planification
                        </button>
                        <button class="btn btn-warning btn-sm mb-2 w-100" onclick="modifyPlanning()">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn btn-info btn-sm w-100" onclick="exportPlanning()">
                            <i class="fas fa-download"></i> Exporter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal assignation de transporteurs -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Assignation automatique</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Critères d'assignation</h6>
                        <form id="assignmentForm">
                            <div class="mb-3">
                                <label for="assignmentStrategy" class="form-label">Stratégie</label>
                                <select class="form-select" id="assignmentStrategy">
                                    <option value="nearest">Transporteur le plus proche</option>
                                    <option value="capacity">Meilleure capacité</option>
                                    <option value="experience">Plus expérimenté</option>
                                    <option value="balanced">Équilibré</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="maxDistance" class="form-label">Distance maximale (km)</label>
                                <input type="number" class="form-control" id="maxDistance" value="50">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="onlyAvailable" checked>
                                    <label class="form-check-label" for="onlyAvailable">
                                        Uniquement les transporteurs disponibles
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="considerRating">
                                    <label class="form-check-label" for="considerRating">
                                        Considérer les évaluations
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Aperçu des assignations</h6>
                        <div id="assignmentPreview" class="assignment-preview">
                            <!-- Prévisualisation des assignations -->
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div id="assignmentResults" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Résultats de l'assignation</h6>
                                <div id="assignmentStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" onclick="previewAssignment()">Aperçu</button>
                <button type="button" class="btn btn-success" onclick="executeAssignment()">Exécuter</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.marker-legend {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.planning-queue {
    max-height: 400px;
    overflow-y: auto;
}

.queue-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.queue-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.queue-item.priority-high {
    border-left: 4px solid #dc3545;
}

.queue-item.priority-normal {
    border-left: 4px solid #ffc107;
}

.queue-item.priority-low {
    border-left: 4px solid #17a2b8;
}

.queue-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 5px;
}

.metric-item {
    text-align: center;
    margin-bottom: 15px;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}

.metric-label {
    font-size: 0.85rem;
    color: #6c757d;
}

.assignment-preview {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
}

.assignment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin-bottom: 5px;
    background: #f8f9fa;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let operationsMap, planningMap;
let planningDirectionsRenderer;

// Initialiser la carte des opérations
function initOperationsMap() {
    operationsMap = new google.maps.Map(document.getElementById('operationsMap'), {
        zoom: 7,
        center: { lat: 33.9716, lng: -6.8498 }, // Maroc
        mapTypeControl: false
    });
    
    // Ajouter des marqueurs pour simuler les opérations
    addOperationMarkers();
}

function addOperationMarkers() {
    // Transporteurs disponibles (vert)
    const availableTransporters = [
        { lat: 33.9716, lng: -6.8498, title: 'Transporteur A - Disponible' },
        { lat: 33.5731, lng: -7.5898, title: 'Transporteur B - Disponible' }
    ];
    
    // Missions en cours (orange)
    const activeMissions = [
        { lat: 34.0209, lng: -6.8416, title: 'Mission en cours - Rabat' },
        { lat: 33.5938, lng: -7.6164, title: 'Mission en cours - Casablanca' }
    ];
    
    // Commandes en attente (rouge)
    const pendingOrders = [
        { lat: 34.2654, lng: -6.5802, title: 'Commande en attente - Salé' },
        { lat: 31.6295, lng: -7.9811, title: 'Commande en attente - Marrakech' }
    ];
    
    // Ajouter les marqueurs
    availableTransporters.forEach(pos => {
        new google.maps.Marker({
            position: pos,
            map: operationsMap,
            title: pos.title,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="8" fill="#28a745" stroke="#fff" stroke-width="2"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(20, 20)
            }
        });
    });
    
    activeMissions.forEach(pos => {
        new google.maps.Marker({
            position: pos,
            map: operationsMap,
            title: pos.title,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="8" fill="#ffc107" stroke="#fff" stroke-width="2"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(20, 20)
            }
        });
    });
    
    pendingOrders.forEach(pos => {
        new google.maps.Marker({
            position: pos,
            map: operationsMap,
            title: pos.title,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="10" r="8" fill="#dc3545" stroke="#fff" stroke-width="2"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(20, 20)
            }
        });
    });
}

// Graphique de performance
const performanceCtx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(performanceCtx, {
    type: 'radar',
    data: {
        labels: ['Efficacité', 'Rapidité', 'Coût', 'Satisfaction', 'Fiabilité'],
        datasets: [{
            label: 'Performance actuelle',
            data: [92, 85, 78, 91, 96],
            borderColor: 'rgb(52, 152, 219)',
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
        }, {
            label: 'Objectif',
            data: [95, 90, 85, 95, 98],
            borderColor: 'rgb(39, 174, 96)',
            backgroundColor: 'rgba(39, 174, 96, 0.1)',
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

function optimizeAllRoutes() {
    showLoading();
    showToast('Optimisation de tous les itinéraires en cours...', 'info');
    
    setTimeout(() => {
        hideLoading();
        showToast('Optimisation terminée! 15% d\'économie de temps réalisée.', 'success');
        
        // Mettre à jour les statistiques
        document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = '87%';
        document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = '142 km';
    }, 3000);
}

function optimizeRoutes() {
    const modal = new bootstrap.Modal(document.getElementById('planningModal'));
    modal.show();
    
    setTimeout(() => {
        initPlanningMap();
    }, 300);
}

function initPlanningMap() {
    if (!planningMap) {
        planningMap = new google.maps.Map(document.getElementById('planningMap'), {
            zoom: 8,
            center: { lat: 33.9716, lng: -6.8498 }
        });
        
        planningDirectionsRenderer = new google.maps.DirectionsRenderer({
            draggable: true,
            panel: null
        });
        planningDirectionsRenderer.setMap(planningMap);
        
        // Simuler un itinéraire optimisé
        showOptimizedRoute();
    }
}

function showOptimizedRoute() {
    const directionsService = new google.maps.DirectionsService();
    
    directionsService.route({
        origin: 'Casablanca, Maroc',
        destination: 'Marrakech, Maroc',
        waypoints: [
            { location: 'Settat, Maroc', stopover: true },
            { location: 'Berrechid, Maroc', stopover: true }
        ],
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    }, function(response, status) {
        if (status === 'OK') {
            planningDirectionsRenderer.setDirections(response);
            
            // Afficher les détails
            const route = response.routes[0];
            let totalDistance = 0;
            let totalDuration = 0;
            
            route.legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });
            
            const details = `
                <div class="planning-summary">
                    <h6>Résumé de l'itinéraire optimisé</h6>
                    <p><strong>Distance totale:</strong> ${(totalDistance / 1000).toFixed(1)} km</p>
                    <p><strong>Durée estimée:</strong> ${Math.round(totalDuration / 3600)} h ${Math.round((totalDuration % 3600) / 60)} min</p>
                    <p><strong>Arrêts:</strong> ${route.waypoint_order.length + 2}</p>
                    <p><strong>Optimisation:</strong> 23% de gain de temps</p>
                    
                    <h6 class="mt-3">Étapes</h6>
                    <ol class="planning-steps">
                        <li>Départ: Casablanca</li>
                        <li>Arrêt 1: Berrechid</li>
                        <li>Arrêt 2: Settat</li>
                        <li>Arrivée: Marrakech</li>
                    </ol>
                </div>
            `;
            
            document.getElementById('planningDetails').innerHTML = details;
        }
    });
}

function assignTransporters() {
    const modal = new bootstrap.Modal(document.getElementById('assignmentModal'));
    modal.show();
    previewAssignment();
}

function previewAssignment() {
    const strategy = document.getElementById('assignmentStrategy').value;
    const maxDistance = document.getElementById('maxDistance').value;
    
    // Simuler des assignations
    const assignments = [
        { order: '#1234', transporter: 'Pierre Martin', distance: '12 km', score: '95%' },
        { order: '#1235', transporter: 'Jean Dupont', distance: '8 km', score: '92%' },
        { order: '#1236', transporter: 'Marie Durand', distance: '15 km', score: '88%' }
    ];
    
    let previewHTML = '';
    assignments.forEach(assignment => {
        previewHTML += `
            <div class="assignment-item">
                <div>
                    <strong>${assignment.order}</strong><br>
                    <small>→ ${assignment.transporter}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">${assignment.score}</span><br>
                    <small>${assignment.distance}</small>
                </div>
            </div>
        `;
    });
    
    document.getElementById('assignmentPreview').innerHTML = previewHTML;
    
    // Afficher les statistiques
    const stats = `
        <div class="row">
            <div class="col-6">Commandes assignées: <strong>3</strong></div>
            <div class="col-6">Taux de réussite: <strong>92%</strong></div>
            <div class="col-6">Distance moyenne: <strong>11.7 km</strong></div>
            <div class="col-6">Temps d'assignation: <strong>0.8s</strong></div>
        </div>
    `;
    
    document.getElementById('assignmentStats').innerHTML = stats;
    document.getElementById('assignmentResults').style.display = 'block';
}

function executeAssignment() {
    showLoading();
    
    setTimeout(() => {
        hideLoading();
        showToast('Assignation exécutée avec succès! 3 transporteurs assignés.', 'success');
        bootstrap.Modal.getInstance(document.getElementById('assignmentModal')).hide();
        
        // Mettre à jour les statistiques
        const pendingCount = document.querySelector('.stat-card:first-child .stat-number');
        pendingCount.textContent = parseInt(pendingCount.textContent) - 3;
    }, 2000);
}

function scheduleDeliveries() {
    showToast('Planification des livraisons en cours...', 'info');
    
    setTimeout(() => {
        showToast('23 livraisons planifiées pour demain', 'success');
        document.getElementById('scheduledDeliveries').textContent = '23';
    }, 2000);
}

function runOptimization() {
    const algorithm = document.getElementById('algorithmType').value;
    const criteria = document.getElementById('optimizationCriteria').value;
    
    showLoading();
    showToast(`Exécution de l'algorithme ${algorithm} en cours...`, 'info');
    
    setTimeout(() => {
        hideLoading();
        
        // Afficher les résultats
        document.getElementById('savedDistance').textContent = '87 km';
        document.getElementById('savedTime').textContent = '2h 15min';
        document.getElementById('savedCost').textContent = '145 €';
        document.getElementById('optimizationResults').style.display = 'block';
        
        showToast('Optimisation terminée avec succès!', 'success');
    }, 4000);
}

function planOrder(orderId) {
    showToast(`Planification de la commande #${orderId}`, 'info');
    optimizeRoutes();
}

function showAllPendingOrders() {
    window.location.href = '/commandes/gerer/?status=en_attente';
}

function validatePlanning() {
    showToast('Planification validée et sauvegardée', 'success');
    bootstrap.Modal.getInstance(document.getElementById('planningModal')).hide();
}

function modifyPlanning() {
    showToast('Mode édition activé', 'info');
}

function exportPlanning() {
    const planningData = `PLANIFICATION OPTIMISEE\n` +
        `Date: ${new Date().toLocaleDateString('fr-FR')}\n\n` +
        `ITINERAIRE:\n` +
        `1. Casablanca (Départ)\n` +
        `2. Berrechid (Arrêt 1)\n` +
        `3. Settat (Arrêt 2)\n` +
        `4. Marrakech (Arrivée)\n\n` +
        `STATISTIQUES:\n` +
        `Distance totale: 241 km\n` +
        `Durée estimée: 3h 45min\n` +
        `Optimisation: 23% de gain`;
    
    const blob = new Blob([planningData], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'planification_optimisee.txt';
    link.click();
    
    showToast('Planification exportée', 'success');
}

function generateOptimizationReport() {
    showLoading();
    
    setTimeout(() => {
        hideLoading();
        
        const reportContent = `RAPPORT D'OPTIMISATION\n` +
            `Période: ${new Date().toLocaleDateString('fr-FR')}\n\n` +
            `RESULTATS:\n` +
            `- Routes optimisées: 45\n` +
            `- Distance économisée: 127 km\n` +
            `- Temps économisé: 8h 30min\n` +
            `- Coût réduit: 15%\n` +
            `- Émissions CO2 réduites: 23%\n\n` +
            `ALGORITHMES UTILISES:\n` +
            `- VRP avec contraintes de capacité\n` +
            `- Optimisation multi-critères\n` +
            `- Prise en compte temps réel du trafic`;
        
        const blob = new Blob([reportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'rapport_optimisation.txt';
        link.click();
        
        showToast('Rapport généré avec succès', 'success');
    }, 2000);
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initOperationsMap();
    
    // Mise à jour des statistiques en temps réel
    setInterval(() => {
        const movingVehicles = document.getElementById('movingVehicles');
        const currentValue = parseInt(movingVehicles.textContent);
        movingVehicles.textContent = currentValue + Math.floor(Math.random() * 3) - 1;
        
        const totalDistance = document.getElementById('totalDistance');
        const currentDistance = parseInt(totalDistance.textContent.replace(/[^\d]/g, ''));
        totalDistance.textContent = (currentDistance + Math.floor(Math.random() * 10)) + ' km';
    }, 10000);
});
</script>
{% endblock %}<div id="operationsMap" class="map-container"></div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Légende</h6>
                        <div class="d-flex align-items-center mb-2">
                            <div class="marker-legend bg-success me-2"></div>
                            <span>Transporteurs disponibles</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="marker-legend bg-warning me-2"></div>
                            <span>Missions en cours</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="marker-legend bg-danger me-2"></div>
                            <span>Commandes en attente</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Statistiques temps réel</h6>
                        <p><strong>Véhicules en mouvement:</strong> <span id="movingVehicles">7</span></p>
                        <p><strong>Distance totale aujourd'hui:</strong> <span id="totalDistance">1,247 km</span></p>
                        <p><strong>Livraisons prévues:</strong> <span id="scheduledDeliveries">23</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list-ul"></i> File d'attente de planification</h5>
            </div>
            <div class="card-body">
                <div class="planning-queue">
                    <div class="queue-item priority-high">
                        <div class="queue-header">
                            <strong>Commande #1234</strong>
                            <span class="badge bg-danger">Urgent</span>
                        </div>
                        <small class="text-muted">Casablanca → Rabat</small>
                        <small class="text-muted">25 kg - Électronique</small>
                        <div class="queue-actions mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="planOrder(1234)">Planifier</button>
                        </div>
                    </div>
                    
                    <div class="queue-item priority-normal">
                        <div class="queue-header">
                            <strong>Commande #1235</strong>
                            <span class="badge bg-warning">Normal</span>
                        </div>
                        <small class="text-muted">Fès → Marrakech</small>
                        <small class="text-muted">15 kg - Textile</small>
                        <div class="queue-actions mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="planOrder(1235)">Planifier</button>
                        </div>
                    </div>
                    
                    <div class="queue-item priority-low">
                        <div class="queue-header">
                            <strong>Commande #1236</strong>
                            <span class="badge bg-info">Faible</span>
                        </div>
                        <small class="text-muted">Agadir → Tanger</small>
                        <small class="text-muted">30 kg - Alimentaire</small>
                        <div class="queue-actions mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="planOrder(1236)">Planifier</button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary" onclick="showAllPendingOrders()">
                        Voir toutes les commandes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Algorithmes d'optimisation -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-brain"></i> Algorithmes d'optimisation</h5>
            </div>
            <div class="card-body">