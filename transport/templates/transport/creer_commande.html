{% extends 'transport/base.html' %}

{% block title %}Créer une commande{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus"></i> Créer une nouvelle commande</h4>
            </div>
            <div class="card-body">
                <form method="post" id="commandeForm">
                    {% csrf_token %}
                    
                    <!-- Informations de la marchandise -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-box"></i> Informations de la marchandise</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="type_marchandise" class="form-label">Type de marchandise *</label>
                            <select class="form-select" id="type_marchandise" name="type_marchandise" required>
                                <option value="">Sélectionner le type</option>
                                <option value="electronique">Électronique</option>
                                <option value="textile">Textile</option>
                                <option value="alimentaire">Alimentaire</option>
                                <option value="meuble">Mobilier</option>
                                <option value="chimique">Produits chimiques</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="poids" class="form-label">Poids (kg) *</label>
                            <input type="number" class="form-control" id="poids" name="poids" min="0.1" step="0.1" required>
                        </div>
                    </div>
                    
                    <!-- Adresse d'enlèvement -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-map-marker-alt"></i> Adresse d'enlèvement</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="rue_enlevement" class="form-label">Rue *</label>
                            <input type="text" class="form-control" id="rue_enlevement" name="rue_enlevement" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ville_enlevement" class="form-label">Ville *</label>
                            <input type="text" class="form-control" id="ville_enlevement" name="ville_enlevement" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="code_postal_enlevement" class="form-label">Code postal *</label>
                            <input type="text" class="form-control" id="code_postal_enlevement" name="code_postal_enlevement" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="pays_enlevement" class="form-label">Pays</label>
                            <select class="form-select" id="pays_enlevement" name="pays_enlevement">
                                <option value="Maroc" selected>Maroc</option>
                                <option value="France">France</option>
                                <option value="Espagne">Espagne</option>
                            </select>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="searchAddress('enlevement')">
                                <i class="fas fa-search"></i> Rechercher sur la carte
                            </button>
                        </div>
                    </div>
                    
                    <!-- Adresse de livraison -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="fas fa-map-marker-alt"></i> Adresse de livraison</h5>
                            <hr>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="rue_livraison" class="form-label">Rue *</label>
                            <input type="text" class="form-control" id="rue_livraison" name="rue_livraison" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ville_livraison" class="form-label">Ville *</label>
                            <input type="text" class="form-control" id="ville_livraison" name="ville_livraison" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="code_postal_livraison" class="form-label">Code postal *</label>
                            <input type="text" class="form-control" id="code_postal_livraison" name="code_postal_livraison" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="pays_livraison" class="form-label">Pays</label>
                            <select class="form-select" id="pays_livraison" name="pays_livraison">
                                <option value="Maroc" selected>Maroc</option>
                                <option value="France">France</option>
                                <option value="Espagne">Espagne</option>
                            </select>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <button type="button" class="btn btn-outline-secondary" onclick="searchAddress('livraison')">
                                <i class="fas fa-search"></i> Rechercher sur la carte
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="row">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'transport:client_dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Retour
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="calculateRoute()">
                                        <i class="fas fa-route"></i> Calculer l'itinéraire
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check"></i> Créer la commande
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Champs cachés pour les coordonnées -->
                    <input type="hidden" id="lat_enlevement" name="lat_enlevement">
                    <input type="hidden" id="lng_enlevement" name="lng_enlevement">
                    <input type="hidden" id="lat_livraison" name="lat_livraison">
                    <input type="hidden" id="lng_livraison" name="lng_livraison">
                </form>
            </div>
        </div>
    </div>
    
    <!-- Carte et informations -->
    <div class="col-md-4">
        <!-- Aperçu de l'itinéraire -->
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-map"></i> Aperçu de l'itinéraire</h6>
            </div>
            <div class="card-body">
                <div id="map" class="map-container"></div>
                
                <div id="routeInfo" class="mt-3" style="display: none;">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h6 class="text-primary mb-1" id="routeDistance">--</h6>
                                <small class="text-muted">Distance</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h6 class="text-success mb-1" id="routeDuration">--</h6>
                            <small class="text-muted">Durée</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estimation des coûts -->
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-calculator"></i> Estimation des coûts</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Transport base:</span>
                            <span id="costBase">--</span>
                        </div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Poids (par kg):</span>
                            <span id="costWeight">--</span>
                        </div>
                    </div>
                    <div class="col-12 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Distance:</span>
                            <span id="costDistance">--</span>
                        </div>
                    </div>
                    <hr>
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <strong>Total estimé:</strong>
                            <strong class="text-primary" id="totalCost">--</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conseils -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Conseils</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        Vérifiez bien les adresses avant de confirmer
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        Indiquez le poids exact de votre marchandise
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        Utilisez la carte pour vérifier l'itinéraire
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de recherche d'adresse -->
<div class="modal fade" id="addressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-map-marker-alt"></i> Rechercher une adresse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="addressSearch" placeholder="Tapez une adresse...">
                </div>
                <div id="modalMap" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="selectAddress()">Sélectionner cette adresse</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, directionsService, directionsRenderer;
let modalMap, modalMarker;
let selectedAddressType = '';

// Initialiser la carte
function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: { lat: 33.9716, lng: -6.8498 }, // Rabat, Maroc
        mapTypeControl: false,
        streetViewControl: false
    });
    
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true,
        panel: null
    });
    directionsRenderer.setMap(map);
}

// Initialiser la carte modale
function initModalMap() {
    modalMap = new google.maps.Map(document.getElementById('modalMap'), {
        zoom: 10,
        center: { lat: 33.9716, lng: -6.8498 }
    });
    
    modalMarker = new google.maps.Marker({
        map: modalMap,
        draggable: true
    });
    
    // Autocomplete pour la recherche
    const searchBox = new google.maps.places.SearchBox(document.getElementById('addressSearch'));
    
    searchBox.addListener('places_changed', function() {
        const places = searchBox.getPlaces();
        if (places.length == 0) return;
        
        const place = places[0];
        modalMarker.setPosition(place.geometry.location);
        modalMap.setCenter(place.geometry.location);
        modalMap.setZoom(15);
    });
    
    // Clic sur la carte
    modalMap.addListener('click', function(event) {
        modalMarker.setPosition(event.latLng);
    });
}

// Rechercher une adresse
function searchAddress(type) {
    selectedAddressType = type;
    const modal = new bootstrap.Modal(document.getElementById('addressModal'));
    modal.show();
    
    // Initialiser la carte modale après ouverture du modal
    setTimeout(() => {
        if (!modalMap) initModalMap();
        google.maps.event.trigger(modalMap, 'resize');
    }, 300);
}

// Sélectionner l'adresse depuis la carte
function selectAddress() {
    const position = modalMarker.getPosition();
    if (!position) {
        showToast('Veuillez sélectionner une position sur la carte', 'warning');
        return;
    }
    
    // Géocodage inverse pour obtenir l'adresse
    const geocoder = new google.maps.Geocoder();
    
    geocoder.geocode({ location: position }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const result = results[0];
            const components = result.address_components;
            
            // Extraire les composants de l'adresse
            let rue = '', ville = '', codePostal = '', pays = '';
            
            components.forEach(component => {
                const types = component.types;
                if (types.includes('route') || types.includes('street_address')) {
                    rue = component.long_name;
                } else if (types.includes('locality')) {
                    ville = component.long_name;
                } else if (types.includes('postal_code')) {
                    codePostal = component.long_name;
                } else if (types.includes('country')) {
                    pays = component.long_name;
                }
            });
            
            // Remplir les champs du formulaire
            if (selectedAddressType === 'enlevement') {
                document.getElementById('rue_enlevement').value = rue || result.formatted_address;
                document.getElementById('ville_enlevement').value = ville;
                document.getElementById('code_postal_enlevement').value = codePostal;
                document.getElementById('lat_enlevement').value = position.lat();
                document.getElementById('lng_enlevement').value = position.lng();
            } else {
                document.getElementById('rue_livraison').value = rue || result.formatted_address;
                document.getElementById('ville_livraison').value = ville;
                document.getElementById('code_postal_livraison').value = codePostal;
                document.getElementById('lat_livraison').value = position.lat();
                document.getElementById('lng_livraison').value = position.lng();
            }
            
            // Fermer le modal
            bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
            showToast('Adresse sélectionnée avec succès', 'success');
            
        } else {
            showToast('Impossible d\'obtenir l\'adresse pour cette position', 'error');
        }
    });
}

// Calculer l'itinéraire
function calculateRoute() {
    const origineRue = document.getElementById('rue_enlevement').value;
    const origineVille = document.getElementById('ville_enlevement').value;
    const destinationRue = document.getElementById('rue_livraison').value;
    const destinationVille = document.getElementById('ville_livraison').value;
    
    if (!origineRue || !origineVille || !destinationRue || !destinationVille) {
        showToast('Veuillez remplir toutes les adresses avant de calculer l\'itinéraire', 'warning');
        return;
    }
    
    const origine = `${origineRue}, ${origineVille}`;
    const destination = `${destinationRue}, ${destinationVille}`;
    
    showLoading();
    
    directionsService.route({
        origin: origine,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING,
        avoidTolls: false,
        avoidHighways: false
    }, function(response, status) {
        hideLoading();
        
        if (status === 'OK') {
            directionsRenderer.setDirections(response);
            
            const route = response.routes[0];
            const leg = route.legs[0];
            
            // Afficher les informations de l'itinéraire
            document.getElementById('routeDistance').textContent = leg.distance.text;
            document.getElementById('routeDuration').textContent = leg.duration.text;
            document.getElementById('routeInfo').style.display = 'block';
            
            // Calculer les coûts
            calculateCosts(leg.distance.value, leg.duration.value);
            
            showToast('Itinéraire calculé avec succès', 'success');
        } else {
            showToast('Impossible de calculer l\'itinéraire: ' + status, 'error');
        }
    });
}

// Calculer les coûts estimés
function calculateCosts(distanceMeters, durationSeconds) {
    const poids = parseFloat(document.getElementById('poids').value) || 0;
    const distanceKm = distanceMeters / 1000;
    
    // Tarifs de base (en euros)
    const tarifBase = 50;
    const tarifParKg = 2;
    const tarifParKm = 1.5;
    
    const coutBase = tarifBase;
    const coutPoids = poids * tarifParKg;
    const coutDistance = distanceKm * tarifParKm;
    const total = coutBase + coutPoids + coutDistance;
    
    document.getElementById('costBase').textContent = coutBase.toFixed(2) + ' €';
    document.getElementById('costWeight').textContent = coutPoids.toFixed(2) + ' €';
    document.getElementById('costDistance').textContent = coutDistance.toFixed(2) + ' €';
    document.getElementById('totalCost').textContent = total.toFixed(2) + ' €';
}

// Recalculer les coûts quand le poids change
document.getElementById('poids').addEventListener('input', function() {
    const routeInfo = document.getElementById('routeInfo');
    if (routeInfo.style.display !== 'none') {
        // Si un itinéraire est déjà calculé, recalculer les coûts
        const distanceText = document.getElementById('routeDistance').textContent;
        if (distanceText !== '--') {
            const distance = parseFloat(distanceText.replace(' km', '').replace(',', '.')) * 1000;
            calculateCosts(distance, 0);
        }
    }
});

// Validation et soumission du formulaire
document.getElementById('commandeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validation basique
    const typeMarc = document.getElementById('type_marchandise').value;
    const poids = document.getElementById('poids').value;
    const rueEnl = document.getElementById('rue_enlevement').value;
    const villeEnl = document.getElementById('ville_enlevement').value;
    const rueLiv = document.getElementById('rue_livraison').value;
    const villeLiv = document.getElementById('ville_livraison').value;
    
    if (!typeMarc || !poids || !rueEnl || !villeEnl || !rueLiv || !villeLiv) {
        showToast('Veuillez remplir tous les champs obligatoires', 'warning');
        return;
    }
    
    if (parseFloat(poids) <= 0) {
        showToast('Le poids doit être supérieur à 0', 'warning');
        return;
    }
    
    // Confirmer la création
    if (confirm('Voulez-vous créer cette commande ?')) {
        showLoading();
        this.submit();
    }
});

// Auto-complétion des adresses
function setupAutocomplete() {
    const options = {
        types: ['address'],
        componentRestrictions: { country: ['ma', 'fr', 'es'] }
    };
    
    new google.maps.places.Autocomplete(document.getElementById('rue_enlevement'), options);
    new google.maps.places.Autocomplete(document.getElementById('rue_livraison'), options);
    new google.maps.places.Autocomplete(document.getElementById('ville_enlevement'), options);
    new google.maps.places.Autocomplete(document.getElementById('ville_livraison'), options);
}

// Initialiser quand la page est chargée
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser la carte principale
    initMap();
    
    // Configurer l'auto-complétion
    setupAutocomplete();
    
    // Calculer automatiquement quand les adresses changent
    ['rue_enlevement', 'ville_enlevement', 'rue_livraison', 'ville_livraison'].forEach(id => {
        document.getElementById(id).addEventListener('blur', function() {
            // Délai pour permettre à l'utilisateur de finir de taper
            setTimeout(() => {
                const origineRue = document.getElementById('rue_enlevement').value;
                const origineVille = document.getElementById('ville_enlevement').value;
                const destinationRue = document.getElementById('rue_livraison').value;
                const destinationVille = document.getElementById('ville_livraison').value;
                
                if (origineRue && origineVille && destinationRue && destinationVille) {
                    calculateRoute();
                }
            }, 1000);
        });
    });
});

// Fonction pour formater les adresses en français
function formatAddress(components) {
    let formatted = {
        rue: '',
        ville: '',
        codePostal: '',
        pays: ''
    };
    
    components.forEach(component => {
        const types = component.types;
        
        if (types.includes('street_number')) {
            formatted.rue = component.long_name + ' ';
        } else if (types.includes('route')) {
            formatted.rue += component.long_name;
        } else if (types.includes('locality') || types.includes('administrative_area_level_2')) {
            formatted.ville = component.long_name;
        } else if (types.includes('postal_code')) {
            formatted.codePostal = component.long_name;
        } else if (types.includes('country')) {
            formatted.pays = component.long_name;
        }
    });
    
    return formatted;
}
</script>
{% endblock %}